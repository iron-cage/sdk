#!/usr/bin/env bash
# Pre-commit hook for documentation validation
#
# Purpose: Automatically validate documentation before allowing commits
# Installation: cp docs/scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Check if any protocol files are being committed
CHANGED_PROTOCOL_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^docs/protocol/.*\.md$' || true)

if [[ -z "$CHANGED_PROTOCOL_FILES" ]]; then
  # No protocol files changed, skip validation
  exit 0
fi

echo "Validating changed protocol files..."
echo ""

# Get script directory
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPTS_DIR="$HOOK_DIR/../../docs/scripts"

# Run validation on changed files only
VALIDATION_FAILED=0

for file in $CHANGED_PROTOCOL_FILES; do
  echo "Validating: $file"

  # Run metadata validator on single file
  if ! "$SCRIPTS_DIR/validate_metadata.sh" "$file" 2>&1 | grep -q "PASS"; then
    VALIDATION_FAILED=1
  fi

  # Run ID format validator on single file
  if ! "$SCRIPTS_DIR/validate_id_format.sh" "$file" 2>&1 | grep -q "CLEAN"; then
    VALIDATION_FAILED=1
  fi
done

if [[ $VALIDATION_FAILED -eq 1 ]]; then
  echo ""
  echo "❌ Pre-commit validation FAILED"
  echo ""
  echo "Fix the validation errors above before committing."
  echo "To bypass this check (not recommended): git commit --no-verify"
  exit 1
fi

echo ""
echo "✅ Pre-commit validation PASSED"
exit 0
