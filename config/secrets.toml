# Secret Distribution Registry
#
# This file documents which modules require which secrets from workspace-secrets.sh
# It serves as the dependency graph for secret distribution and validation.
#
# Format:
# [modules.{module_name}]
# required_secrets = ["SECRET_NAME", ...]
# optional_secrets = ["SECRET_NAME", ...]
# priority = "P0" | "P1" | "P2" | "P3"
# deployment_modes = ["pilot", "development", "production"]

# =============================================================================
# P0 (CRITICAL) - Core API and Security
# =============================================================================

[modules.iron_control_api]
description = "REST API server for token management, budgets, and authentication"
required_secrets = [
  "DATABASE_URL",
  "JWT_SECRET",
  "IC_TOKEN_SECRET",
  "IP_TOKEN_KEY",
  "IRON_SECRETS_MASTER_KEY",
]
optional_secrets = []
priority = "P0"
deployment_modes = ["pilot", "development", "production"]
validation_notes = """
  Production mode enforces strict validation:
  - JWT_SECRET must not be 'dev-secret-change-in-production'
  - IC_TOKEN_SECRET must not contain 'dev-'
  - IP_TOKEN_KEY must not be all zeros
  - See iron_control_api_server.rs:382 for validation logic
"""

[modules.iron_secrets]
description = "Cryptographic service for provider key encryption"
required_secrets = [
  "IRON_SECRETS_MASTER_KEY",
]
optional_secrets = []
priority = "P0"
deployment_modes = ["pilot", "development", "production"]
validation_notes = """
  Master key must be 32 bytes (44 base64 characters)
  Loss of this key = permanent loss of all encrypted API keys
"""

# =============================================================================
# P1 (HIGH) - Runtime and CLI
# =============================================================================

[modules.iron_runtime]
description = "Agent runtime with LLM router and budget enforcement"
required_secrets = [
  "IC_TOKEN_SECRET",
  "IP_TOKEN_KEY",
  "IRON_SECRETS_MASTER_KEY",
]
optional_secrets = [
  "OPENAI_API_KEY",
  "ANTHROPIC_API_KEY",
]
priority = "P1"
deployment_modes = ["pilot", "development", "production"]
validation_notes = """
  Provider API keys are optional - runtime fetches from iron_control_api
  Direct provider keys only used as fallback in standalone mode
"""

[modules.iron_cli]
description = "Command-line interface for iron_control and iron_token APIs"
required_secrets = [
  "DATABASE_URL",
  "JWT_SECRET",
]
optional_secrets = [
  "OPENAI_API_KEY",
  "ANTHROPIC_API_KEY",
]
priority = "P1"
deployment_modes = ["pilot", "development"]
validation_notes = """
  CLI uses layered configuration hierarchy
  See iron_cli/src/config.rs for 6-level hierarchy implementation
"""

[modules.iron_test_db]
description = "Test database factory with auto-cleanup"
required_secrets = []
optional_secrets = [
  "DATABASE_URL",
  "CI",
]
priority = "P1"
deployment_modes = ["pilot", "development"]
validation_notes = """
  DATABASE_URL is auto-constructed using workspace_tools:
  - CI: workspace_root/target/test_databases/{test_name}.db
  - Local: tempfile (auto-cleanup)
"""

# =============================================================================
# P2 (MEDIUM) - Token Management and Dashboard
# =============================================================================

[modules.iron_token_manager]
description = "API token generation, validation, and storage"
required_secrets = [
  "DATABASE_URL",
]
optional_secrets = []
priority = "P2"
deployment_modes = ["pilot", "development", "production"]
validation_notes = """
  Used internally by iron_control_api
  Database access required for token persistence
"""

[modules.iron_dashboard]
description = "Vue.js frontend for API management"
required_secrets = []
optional_secrets = [
  "VITE_API_URL",
]
priority = "P2"
deployment_modes = ["pilot", "development"]
validation_notes = """
  VITE_API_URL defaults to http://localhost:3000
  Only needed if API runs on non-standard port
"""

# =============================================================================
# P3 (LOW) - Analytics and Telemetry
# =============================================================================

[modules.iron_telemetry]
description = "Observability and metrics collection"
required_secrets = []
optional_secrets = []
priority = "P3"
deployment_modes = ["pilot", "development", "production"]

[modules.iron_runtime_analytics]
description = "Runtime performance analytics"
required_secrets = []
optional_secrets = []
priority = "P3"
deployment_modes = ["pilot", "development", "production"]

[modules.iron_cli_py]
description = "Python bindings for iron_cli"
required_secrets = []
optional_secrets = [
  "OPENAI_API_KEY",
  "ANTHROPIC_API_KEY",
]
priority = "P3"
deployment_modes = ["pilot", "development"]

# =============================================================================
# SECRET DEPENDENCY GRAPH
# =============================================================================

[secrets.DATABASE_URL]
description = "SQLite connection string for database persistence"
required_by = ["iron_control_api", "iron_token_manager", "iron_cli"]
optional_for = ["iron_test_db"]
validation = "Must include ?mode=rwc for SQLite"

[secrets.JWT_SECRET]
description = "Secret key for JWT access and refresh tokens"
required_by = ["iron_control_api", "iron_cli"]
optional_for = []
validation = "64 hex characters (32 bytes)"

[secrets.IC_TOKEN_SECRET]
description = "Secret key for IC Token (Budget Control Protocol)"
required_by = ["iron_control_api", "iron_runtime"]
optional_for = []
validation = "64 hex characters (32 bytes)"

[secrets.IP_TOKEN_KEY]
description = "AES-256-GCM key for IP Token encryption"
required_by = ["iron_control_api", "iron_runtime"]
optional_for = []
validation = "64 hex characters (32 bytes), not all zeros"

[secrets.IRON_SECRETS_MASTER_KEY]
description = "Master key for provider API key encryption"
required_by = ["iron_control_api", "iron_secrets", "iron_runtime"]
optional_for = []
validation = "44 base64 characters (32 bytes)"

[secrets.OPENAI_API_KEY]
description = "OpenAI API key for GPT models"
required_by = []
optional_for = ["iron_runtime", "iron_cli", "iron_cli_py"]
validation = "Starts with 'sk-', 48+ characters"

[secrets.ANTHROPIC_API_KEY]
description = "Anthropic API key for Claude models"
required_by = []
optional_for = ["iron_runtime", "iron_cli", "iron_cli_py"]
validation = "Starts with 'sk-ant-', 100+ characters"

[secrets.IRON_DEPLOYMENT_MODE]
description = "Explicit deployment mode control"
required_by = []
optional_for = ["iron_control_api"]
validation = "One of: pilot, development, production"

[secrets.VITE_API_URL]
description = "Backend API URL for frontend"
required_by = []
optional_for = ["iron_dashboard"]
validation = "Valid HTTP/HTTPS URL"

# =============================================================================
# DEPLOYMENT MODE REQUIREMENTS
# =============================================================================

[deployment.pilot]
description = "Localhost development environment"
required_secrets = []
notes = """
  Pilot mode uses defaults for all secrets
  Suitable only for local development
  Never deploy pilot mode to public networks
"""

[deployment.development]
description = "Explicit development mode with database wiping"
required_secrets = []
notes = """
  Development mode clears database on startup
  Use for integration testing and local development
  Not suitable for production
"""

[deployment.production]
description = "Production deployment with strict validation"
required_secrets = [
  "DATABASE_URL",
  "JWT_SECRET",
  "IC_TOKEN_SECRET",
  "IP_TOKEN_KEY",
  "IRON_SECRETS_MASTER_KEY",
]
forbidden_values = {
  JWT_SECRET = ["dev-secret-change-in-production"],
  IC_TOKEN_SECRET = ["dev-ic-token-secret-change-in-production"],
  IP_TOKEN_KEY = ["0000000000000000000000000000000000000000000000000000000000000000"],
}
notes = """
  Production mode enforces:
  - No default/dev secrets
  - Strict secret validation
  - PostgreSQL recommended over SQLite
  - See iron_control_api_server.rs:382 for enforcement logic
"""

# =============================================================================
# MIGRATION PLAN
# =============================================================================

[migration]
old_files = [
  "secret/-iron.sh",
  "secret/-api_keys.sh",
  "dev/.env",
  "dev/module/iron_dashboard/.env",
]
new_file = "secret/workspace-secrets.sh"
status = "Phase 0 - Foundation (Week 1)"
notes = """
  Migration steps:
  1. Create workspace-secrets.sh (DONE)
  2. Update Makefile to source workspace-secrets.sh
  3. Update .gitignore to exclude workspace-secrets.sh
  4. Deprecate old secret files (leave examples for documentation)
  5. Update deployment documentation
"""
